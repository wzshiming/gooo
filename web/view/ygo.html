<div id="ygo">

<link rel="stylesheet" type="text/css" href="css/container.css" />
<script src="js/three.js"></script>
<script src="js/libs/tween.min.js"></script>
<script src="js/controls/TrackballControls.js"></script>
<script src="js/renderers/CSS3DDoubleRenderer.js"></script>


<div id="container"></div>

<script>

var camera, scene, renderer;
var controls;

var objects = [];

var PI = 3.1415926539


var Step = function(func){
    window.setTimeout(func,1000)
}

var Desk = function(i){
    this.site = [
        1,3,
        1,5, //融合卡
        19,1,
        19,3, //墓地
        19,5, //卡组
        4,4,  //魔陷
        7,4,
        10,4,
        13,4,
        16,4,
        4,2,  //怪兽
        7,2,
        10,2,
        13,2,
        16,2,
        7,7,  //手牌
        8,7,
        9,7,
        10,7,
        11,7,
        12,7,
    ]
    this.x = 0
    this.y = 0

    if(i == 0){
        this.angle =  0
    }else if(i == 1){
        this.angle =  PI
    }else if(i == 1){
        this.angle =  PI*0.5
    }else if(i == 1){
        this.angle =  PI*1.5
    }
}

Desk.prototype.deck = function(){
    var x = 19
    var y = 5
    var a = this.angle
    return this.Pile(x,y,a)
}


Desk.prototype.hand = function(){
    var x = 7
    var y = 7
    var a = this.angle
    return this.Tile(x,y,a)
}


Desk.prototype.Pile = function(x,y,a){
    return function(i){
        var object = new THREE.Object3D();
        var rotation = new THREE.Matrix4().makeRotationZ(a);
        object.matrix.makeTranslation(
                ( x * 100 ) - 1000 + i,
                - ( y * 150 ) + i,
                i);
        object.applyMatrix(rotation)
        return object
    }
}


Desk.prototype.Tile = function(x,y,a){
    return function(i){
        var object = new THREE.Object3D();
        var rotation = new THREE.Matrix4().makeRotationZ(a);
        object.matrix.makeTranslation(
                ( (x + i) * 100 ) - 1000 ,
                - ( y * 150 ),
                0);
        object.applyMatrix(rotation)
        return object
    }
}



function CardFront(i) {
    return '<img class="card" src="/cards/img/' + i + '.jpg"  alt="" />';
}

function CardBack(i) {
    return '<img class="card" src="/cards/cover/' + i + '.jpg"  alt="" />';
}

var allCard = {}

var Card = function(uniq,master){
    var element = document.createElement( 'div' );
    element.innerHTML = CardFront(0);
    var element2 = document.createElement( 'div' );
    element2.innerHTML = CardBack(0);
    this.object = new THREE.CSS3DDoubleObject( element,element2 );
    this.object.position.x = Math.random() * 4000 - 2000;
    this.object.position.y = Math.random() * 4000 - 2000;
    this.object.position.z = 4000;
    this.uniq = uniq;
    this.hold = null;
    this.master = master;
    allCard[uniq] = this;
    scene.add( this.object );
    element.hold = this
    element.onclick = function(){
        console.dir(this.hold.uniq)
    }
    element2.hold = element.hold
    element2.onclick = element.onclick
}
Card.prototype.placed = function(){
    if(this.hold!=null){
        return this.hold.placed(this.uniq)
    }
    return this
}

Card.prototype.SetFront = function(i){
    this.object.element.innerHTML = CardFront(i);
}

Card.prototype.Move = function(pos){
    Translate(this.object,pos.position,1000)
}

Card.prototype.FaceUp = function(){
    Rotate(this.object,{y:0},1000)
}

Card.prototype.FaceDown = function(){
    Rotate(this.object,{y:PI},1000)
}

Card.prototype.Attack = function(){
    Rotate(this.object,{z:0},1000)
}

Card.prototype.Defense = function(){
    Rotate(this.object,{z:PI},1000)
}

Card.prototype.Stop = function(){
    TWEEN.remove(this.object)
}

var Cards = function (place) {
    this.place = place
    this.deck = []
}

Cards.prototype.placed = function(u){
    var i = this.index(u)
    if(i>=0){
        var c = this.deck.splice(i,1)[0]
        c.hold = null
        return c
    }
    return null
}

Cards.prototype.index = function(u){
    for(var i in this.deck){
        if(this.deck[i].uniq == u){
            return i
        }
    }
    return -1
}

Cards.prototype.push = function(obj){
    var i = obj.placed()
    i.Stop()
    i.Move(this.place(this.length()))
    i.hold = this
    this.deck.push(i)
}

Cards.prototype.pop = function(){
    //i.Move(this.place.leave())
    var c= this.deck.pop()
    c.hold = null
    return c
}

Cards.prototype.length = function(){
    return this.deck.length
}

var Player = function(k,i){
    var c = new Desk(k)
    if(k==0){
        this.self = true;
    }
    this.index = i
    this.hand= new Cards(c.hand())    //手牌
    this.deck= new Cards(c.deck())    //卡组 40 ~ 60
//    this.extra= new Cards()   //额外卡组 <= 15 融合怪物 同调怪物 超量怪物
//    this.side= new Cards()    //副卡组 <= 15
//    this.removed= new Cards() //排除卡
//    this.grave= new Cards()   //墓地
//    this.mzone= new Cards()   //怪物卡区 5
//    this.szone= new Cards()   //魔法卡陷阱卡区 5
//    this.field= new Cards()   //场地卡 5
}

Player.prototype.move2head = function(u){
    var c = this.deck.placed(u)
    if(c==null){
        return
    }
    this.hand.push(c)
    if(this.self == true){
        c.FaceUp()
    }
}

Player.prototype.Draw = function(u){
    var c = this.deck.placed(u)
    if(c==null){
        return
    }
    this.hand.push(c)
    if(this.self == true){
        c.FaceUp()
    }
}

var YGO = function(){
    this.players = []
    var t = this
    ws.SendMsg({{ key "Chan.Room.GameRegister" }},{} ,function(e){
        if(typeof e.method  == "string"){
            if(typeof t[e.method] == "function") {
                t[e.method](e.args);
            }
            else MsgErr(e.method)
        }
    });
}

YGO.prototype.move2head = function(args){
    allCard[args.uniq].master.move2head(args.uniq)
}

YGO.prototype.setFront = function(args){
    allCard[args.uniq].SetFront(args.desk)
}

YGO.prototype.init = function(){
    var t = this
    ws.SendMsg( {{ key "Chan.Room.GameInit" }} ,{},function(e){
        t.users = e.users;
        t.index = e.index;
        if(t.users instanceof Array) {
            for(var i = 0;i!=t.users.length;i++){
                var k = i + t.index;
                if(k >= t.users.length){
                    k = k - t.users.length;
                }

                var p = new Player(k,i)
                for(var j in t.users[i].deck){
                    var cc = new Card(t.users[i].deck[j],p)
                    cc.FaceDown()
                    p.deck.push(cc)
                }
                t.players[i] = p;
            }
        }else {
            MsgErr("初始化游戏错误");
        }
        return true;
    });
}



function init() {
    var ygo = new YGO()
//    ws.Register({{ key "Chan.Room.Game" }},function(msg){
//        if(msg.status == "gameinit"){

//        }
    //MsgInfo(JSON.stringify(msg))
//    })
//    ws.SendMsg( {{ key "Chan.Room.Game" }} ,{hand:"init"})

}

function Tween(object, target, duration) {
    new TWEEN.Tween( object )
            .to( target, duration )
            .easing( TWEEN.Easing.Exponential.InOut )
            .start();
}

function Translate(object, target, duration){
    Tween(object.position,target,(Math.random() + 0.3 ) *  duration)
}

function Rotate(object, target, duration){
    Tween(object.rotation,target,(Math.random() + 0.1 ) *  duration)
}

function Move( object, target, duration ) {
    //TWEEN.remove(object)
    Translate(object,{ x: target.position.x, y: target.position.y, z: target.position.z },duration)
    Rotate(object,{ x: target.rotation.x, y: target.rotation.y, z: target.rotation.z },duration)
}

function Moves( objects, targets, duration ) {
    //TWEEN.removeAll();
    for ( var i = 0; i < objects.length; i ++ ) {
        Move(objects[ i ],targets[ i ],duration)
    }
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
    render();
}

function animate() {
    requestAnimationFrame( animate );
    TWEEN.update();
    controls.update();
    render()
}

function render() {
    renderer.render( scene, camera );
}

function Start(){
    camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
    camera.position.z = 3000;
    scene = new THREE.Scene();
    renderer = new THREE.CSS3DRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.domElement.style.position = 'absolute';
    document.getElementById( 'container' ).appendChild( renderer.domElement );
    controls = new THREE.TrackballControls( camera, renderer.domElement );
    //controls.rotateSpeed = 0;
    //controls.minDistance = 3000;
    //controls.maxDistance = 3000;
    controls.addEventListener( 'Tween', render );
    controls.noRotate = true;
    controls.noZoom = true;
    controls.noPan = true;
    controls.noRoll = true;
    window.addEventListener( 'resize', onWindowResize, false );
    init();
    animate();
}

$('#ygo').hide();
</script>
</div>