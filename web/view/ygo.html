<div id="ygo">

<link rel="stylesheet" type="text/css" href="css/container.css" />
<script src="js/three.js"></script>
<script src="js/libs/tween.min.js"></script>
<script src="js/controls/TrackballControls.js"></script>
<script src="js/renderers/CSS3DDoubleRenderer.js"></script>


<div id="container"></div>

<script>

var PI = 3.1415926539

var place= function (angle,x,y){
    var site = [
        1,3,
        1,5, //融合卡
        19,1,
        19,3, //墓地
        19,5, //卡组
        4,4,  //魔陷
        7,4,
        10,4,
        13,4,
        16,4,
        4,2,  //怪兽
        7,2,
        10,2,
        13,2,
        16,2,
        7,7,  //手牌
        8,7,
        9,7,
        10,7,
        11,7,
        12,7,
    ]
    var rotation = new THREE.Matrix4().makeRotationZ(angle);
    return function(index){
        var object = new THREE.Object3D();
        object.matrix.makeTranslation(
                ( site[ index*2 ] * 100 ) - 1000 + x,
                - ( site[ index*2 + 1 ] * 150 ) + y ,
                0);
        object.applyMatrix(rotation)
        return object;
    }
}

var NewDeck = function () {
    var deck = []
    var cards = {}
    cards.push = function(i){
        deck.push(i)
    }
    cards.pop = function(){
        return deck.pop()
    }
    return cards
}

var player = function (angle){
    var pl = place(angle,0,0);
    var deck = []
    var hand = []
    players = {}
    players.init = function (size){
        for ( var i = 0; i < size; i += 1 ) {
            var obj = NewCards()
            deck.push(obj)
            obj.Move(pl(4))
            obj.FaceDown()
        }
    }
    players.draw = function (size){
        for ( var i = 0; i < size; i += 1 ) {
            var obj = deck.pop()
            hand.push(obj)
            //hand.length()
            obj.Move(pl(15+i))
            if(angle==0) {
                obj.FaceUp()
            } else {
                obj.FaceDown()
            }
        }
    }
    return players
}


var camera, scene, renderer;
var controls;

var objects = [];



function CardFront(i) {
    return '<img class="card" src="/cards/img/' + i + '.jpg"  alt="" />'
}

function CardBack(i) {
    return '<img class="card" src="/cards/cover/' + i + '.jpg"  alt="" />'
}

function NewCards() {
    var element = document.createElement( 'div' );
    element.innerHTML = CardFront(0);
    var element2 = document.createElement( 'div' );
    element2.innerHTML = CardBack(0);
    var object = new THREE.CSS3DDoubleObject( element,element2 );
    object.position.x = Math.random() * 4000 - 2000;
    object.position.y = Math.random() * 4000 - 2000;
    object.position.z = 4000;
    scene.add( object );
    var target = new THREE.Object3D();

    object.SetType = function (name,id){
        object.element.innerHTML = CardFront(name)
        object.CardsType = name;
        object.CardsId = id;
    }

    object.Move = function (pos){
        Translate(object,pos.position,1000)
    }

    object.FaceUp = function(){
        Rotate(object,{y:0},1000)
    }

    object.FaceDown = function(){
        Rotate(object,{y:PI},1000)

    }

    object.Attack = function(){
        Rotate(object,{z:0},1000)

    }

    object.Defense = function(){
        Rotate(object,{z:PI},1000)
    }
    object.SetType(0,0);
    return object
}

function init() {
//    ws.Register({{ key "Chan.Room.Game" }},function(msg){
//        if(msg.status == "gameinit"){

//        }
    //MsgInfo(JSON.stringify(msg))
//    })
//    ws.SendMsg( {{ key "Chan.Room.Game" }} ,{hand:"init"})

    console.dir(document);
    var user1 = player(0)
    var user2 = player(PI)
    user1.init(60)
    user2.init(60)
    //window.setInterval(fun,9000)
    window.setTimeout(function(){
        user1.draw(5)
        user2.draw(5)
    },2200)
}

function Tween(object, target, duration) {
    new TWEEN.Tween( object )
            .to( target, duration )
            .easing( TWEEN.Easing.Exponential.InOut )
            .start();
}

function Translate(object, target, duration){
    Tween(object.position,target,(Math.random() + 0.3 ) *  duration)
}

function Rotate(object, target, duration){
    Tween(object.rotation,target,(Math.random() + 0.1 ) *  duration)
}

function Move( object, target, duration ) {
    //TWEEN.remove(object)
    Translate(object,{ x: target.position.x, y: target.position.y, z: target.position.z },duration)
    Rotate(object,{ x: target.rotation.x, y: target.rotation.y, z: target.rotation.z },duration)
}

function Moves( objects, targets, duration ) {
    //TWEEN.removeAll();
    for ( var i = 0; i < objects.length; i ++ ) {
        Move(objects[ i ],targets[ i ],duration)
    }
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
    render();
}

function animate() {
    requestAnimationFrame( animate );
    TWEEN.update();
    controls.update();
    render()
}

function render() {
    renderer.render( scene, camera );
}

function Start(){
    camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
    camera.position.z = 3000;
    scene = new THREE.Scene();
    renderer = new THREE.CSS3DRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.domElement.style.position = 'absolute';
    document.getElementById( 'container' ).appendChild( renderer.domElement );
    controls = new THREE.TrackballControls( camera, renderer.domElement );
    //controls.rotateSpeed = 0;
    //controls.minDistance = 3000;
    //controls.maxDistance = 3000;
    controls.addEventListener( 'Tween', render );
    controls.noRotate = true;
    controls.noZoom = true;
    controls.noPan = true;
    controls.noRoll = true;
    window.addEventListener( 'resize', onWindowResize, false );
    init();
    animate();
}

$('#ygo').hide();
</script>
</div>