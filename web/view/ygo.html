<div id="ygo">

<link rel="stylesheet" type="text/css" href="css/container.css" />
<script src="js/three.js"></script>
<script src="js/libs/tween.min.js"></script>
<script src="js/controls/TrackballControls.js"></script>
<script src="js/renderers/CSS3DDoubleRenderer.js"></script>


<div id="container"></div>

<script>

var camera, scene, renderer;
var controls;

var objects = [];

var PI = 3.1415926539



var Desk = function(i){
    this.site = [
        1,3,
        1,5, //融合卡
        19,1,
        19,3, //墓地
        19,5, //卡组
        4,4,  //魔陷
        7,4,
        10,4,
        13,4,
        16,4,
        4,2,  //怪兽
        7,2,
        10,2,
        13,2,
        16,2,
        7,7,  //手牌
        8,7,
        9,7,
        10,7,
        11,7,
        12,7,
    ]
    this.x = 0
    this.y = 0

    if(i == 0){
        this.angle =  0
    }else if(i == 1){
        this.angle =  PI
    }else if(i == 1){
        this.angle =  PI*0.5
    }else if(i == 1){
        this.angle =  PI*1.5
    }
}

Desk.prototype.deck = function(){
    var x = 19
    var y = 5
    var a = this.angle
    return this.Pile(x,y,a)
}


Desk.prototype.hand = function(){
    var x = 7
    var y = 7
    var a = this.angle
    return this.Tile(x,y,a)
}


Desk.prototype.Pile = function(x,y,a){
    return function(i){
        var object = new THREE.Object3D();
        var rotation = new THREE.Matrix4().makeRotationZ(a);
        object.matrix.makeTranslation(
                ( x * 100 ) - 1000 + i,
                - ( y * 150 ) + i,
                i);
        object.applyMatrix(rotation)
        return object
    }
}


Desk.prototype.Tile = function(x,y,a){
    return function(i){
        var object = new THREE.Object3D();
        var rotation = new THREE.Matrix4().makeRotationZ(a);
        object.matrix.makeTranslation(
                ( (x + i) * 100 ) - 1000 ,
                - ( y * 150 ),
                0);
        object.applyMatrix(rotation)
        return object
    }
}



var Cards = function (place) {
    this.place = place
    this.deck = []
}

Cards.prototype.push = function(i){
    i.Stop()
    i.Move(this.place(this.length()))
    this.deck.push(i)
}

Cards.prototype.pop = function(){
    //i.Move(this.place.leave())
    return this.deck.pop()
}

Cards.prototype.length = function(){
    return this.deck.length
}


var Player = function(i){
    var c = new Desk(i)
    this.hand= new Cards(c.hand())    //手牌
    this.deck= new Cards(c.deck())    //卡组 40 ~ 60
//    this.extra= new Cards()   //额外卡组 <= 15 融合怪物 同调怪物 超量怪物
//    this.side= new Cards()    //副卡组 <= 15
//    this.removed= new Cards() //排除卡
//    this.grave= new Cards()   //墓地
//    this.mzone= new Cards()   //怪物卡区 5
//    this.szone= new Cards()   //魔法卡陷阱卡区 5
//    this.field= new Cards()   //场地卡 5
}

Player.prototype.Draw = function(){
    this.hand.push(this.deck.pop())
}

var YGO = function(){
}


YGO.prototype.Init = function(){
    ws.SendMsg( {{ key "Chan.Room.GameInit" }} ,{},function(e){
        this.players = [];
        this.users = e.users;
        this.index = e.index;
        if(this.users instanceof Array) {
            for(var i = 0;i!=this.users.length;i++){
                var k = i + this.index;
                if(k >= this.users.length){
                    k = k - this.users.length;
                }
                var p = new Player(k)
                console.log(this)
                for(tt in this.users[i].deck){
                    var cc = new Card(tt)
                    cc.FaceDown()
                    p.deck.push(cc)
                }
                this.players[i] = p;
            }
        }else {
            MsgErr("初始化游戏错误")
        }
    });
}



function CardFront(i) {
    return '<img class="card" src="/cards/img/' + i + '.jpg"  alt="" />'
}

function CardBack(i) {
    return '<img class="card" src="/cards/cover/' + i + '.jpg"  alt="" />'
}

var Card = function(id){
    var element = document.createElement( 'div' );
    element.innerHTML = CardFront(0);
    var element2 = document.createElement( 'div' );
    element2.innerHTML = CardBack(0);
    this.object = new THREE.CSS3DDoubleObject( element,element2 );
    this.object.position.x = Math.random() * 4000 - 2000;
    this.object.position.y = Math.random() * 4000 - 2000;
    this.object.position.z = 4000;
    this.id = id;
    scene.add( this.object );
}

Card.prototype.Move = function(pos){
    Translate(this.object,pos.position,1000)
}

Card.prototype.FaceUp = function(){
    Rotate(this.object,{y:0},1000)
}

Card.prototype.FaceDown = function(){
    Rotate(this.object,{y:PI},1000)
}

Card.prototype.Attack = function(){
    Rotate(this.object,{z:0},1000)
}

Card.prototype.Defense = function(){
    Rotate(this.object,{z:PI},1000)
}

Card.prototype.Stop = function(){
    TWEEN.remove(this.object)
}


function init() {
    var ygo = new YGO()
    ygo.Init()
//    ws.Register({{ key "Chan.Room.Game" }},function(msg){
//        if(msg.status == "gameinit"){

//        }
    //MsgInfo(JSON.stringify(msg))
//    })
//    ws.SendMsg( {{ key "Chan.Room.Game" }} ,{hand:"init"})

}

function Tween(object, target, duration) {
    new TWEEN.Tween( object )
            .to( target, duration )
            .easing( TWEEN.Easing.Exponential.InOut )
            .start();
}

function Translate(object, target, duration){
    Tween(object.position,target,(Math.random() + 0.3 ) *  duration)
}

function Rotate(object, target, duration){
    Tween(object.rotation,target,(Math.random() + 0.1 ) *  duration)
}

function Move( object, target, duration ) {
    //TWEEN.remove(object)
    Translate(object,{ x: target.position.x, y: target.position.y, z: target.position.z },duration)
    Rotate(object,{ x: target.rotation.x, y: target.rotation.y, z: target.rotation.z },duration)
}

function Moves( objects, targets, duration ) {
    //TWEEN.removeAll();
    for ( var i = 0; i < objects.length; i ++ ) {
        Move(objects[ i ],targets[ i ],duration)
    }
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
    render();
}

function animate() {
    requestAnimationFrame( animate );
    TWEEN.update();
    controls.update();
    render()
}

function render() {
    renderer.render( scene, camera );
}

function Start(){
    camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
    camera.position.z = 3000;
    scene = new THREE.Scene();
    renderer = new THREE.CSS3DRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.domElement.style.position = 'absolute';
    document.getElementById( 'container' ).appendChild( renderer.domElement );
    controls = new THREE.TrackballControls( camera, renderer.domElement );
    //controls.rotateSpeed = 0;
    //controls.minDistance = 3000;
    //controls.maxDistance = 3000;
    controls.addEventListener( 'Tween', render );
    controls.noRotate = true;
    controls.noZoom = true;
    controls.noPan = true;
    controls.noRoll = true;
    window.addEventListener( 'resize', onWindowResize, false );
    init();
    animate();
}

$('#ygo').hide();
</script>
</div>